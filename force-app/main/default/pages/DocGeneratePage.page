<apex:page controller="DocGenerateController"
		   applyHtmlTag="false" showHeader="false" cache="false">
           
    <html>
        <head>
            <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
            <style>
                body{
                    height: 100vh;
                    overflow: hidden;
                    /* font-size: 0.8125rem;
                    line-height: 19.2px; */
                }         
                .page-break {
                    display:block;
                    page-break-after:always;
                    visibility: hidden !important;
                }         
                h1, h2, h3, h4, h5, h6, p, ol, ul, dl, fieldset{
                    margin: 0;
                    padding: 0;
                }
                /* **** ***** ****** toolbar CSS -- START **** ***** ****** */
                .pdf_toolbar{
                    width: 100%;
                    height: 3.5rem;
                    background: #01AEFF;

                    display: flex;
                    justify-content: center;
                    align-items: center;
                    user-select: none;
                }
                .configContainet{
                    width: 100%;
                    height: fit-content;

                    display: flex;
                    justify-content: center;
                    align-items: center;
                    gap: 1rem;
                }
                .configContainet button{
                    border: none;
                    outline: none;
                    background: inherit;
                }
                .configContainet button:active{
                    background: initial;
                }
                .config_cc{
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    gap: 0.25rem;
                }
                .config_cc:not(:last-child){
                    padding-right: 1rem;
                    border-right: 1.5px solid white;
                }
                .pageConfig{
                    gap: 0.5rem;
                }
                .pageChangeConfig{
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    gap: 1px;
                }
                .pageChangeBtn{
                    background: #e5f7ffcc !important;
                    min-width: 1.5rem;
                    min-height: 1.5rem;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    padding-inline: 0.75rem;
                    padding-block: 5px;
                    cursor: pointer;
                }
                .pageMinus{
                    border-radius: 4px 0px 0px 4px;
                }
                .pagePlus{
                    border-radius: 0px 4px 4px 0px ;
                }
                .pageChangeBtn svg{
                    width: 16px;
                    height: 16px;
                    fill: currentColor;
                }
                .pageChangeBtn:disabled{
                    cursor: no-drop;
                }
                input[type=number]::-webkit-inner-spin-button, 
                input[type=number]::-webkit-outer-spin-button { 
                    -webkit-appearance: none;
                    -moz-appearance: none;
                    appearance: none;
                    margin: 0; 
                }
                .pageToSetInut{
                    width: 2.5rem;
                    height: 1.5rem;
                    border: none;
                    outline: none;
                    text-align: center;
                    padding-block: 1px;
                    background: #e5f7ffcc !important;
                }
                .pageToSetInut[data-name="totalPages"]{
                    border-radius: 2px; 
                }
                .pageToSetInut:focus-visible,
                .zoomInpput:focus-visible{
                    border: none;
                    outline: : none !important;
                }
                .toolbarText{
                    font-size: 14px;
                    font-family: Bahnschrift, 'Segoe UI', 'Segoe UI Web (West European)', -apple-system, BlinkMacSystemFont, Roboto, 'Helvetica Neue', sans-serif;
                    letter-spacing: 1px;
                    color: #d7f3ff;
                }
                .zoomConfig{
                    gap: 0px;
                }
                .zoomBtn{
                    width: 16px;
                    height: 16px;
                    fill: #b7e9ff;
                    padding: 0.25rem;
                    cursor: pointer;
                    transition: all linear 0.1s;
                    outline: 1px solid #b7e9ff;
                }
                .zI{
                    border-radius: 4px 0px 0px 4px;
                }
                .zO{
                    border-radius: 0px 4px 4px 0px;
                }
                .zoomBtn:hover{
                    background: #e5f7ffcc !important;
                    fill: #01aeff;
                }
                .zoomInfo{
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    padding-bottom: 1px;
                    border-radius: 2px;
                }
                 /* **** ***** ****** toolbar CSS -- END **** ***** ****** */

                 
                .content{
                    --zoomLevel: 100%;
                    min-width: 100%;
                    width: 100%;
                    max-width: max-content;
                    height: calc(100% - 3.5rem - 2rem);
                    overflow: auto;
                    /* background: rgb(226 247 255); */
                    background: #4d525d;
                    padding-block: 1rem;
                    position: relative;
                    scroll-behavior: smooth;
                    scrollbar-width: thin;
                    scrollbar-color: #01aeff transparent;
                }

                .intialLoading{
                    width: calc(100% - 4rem);
                    border-radius: 4px;
                    height: 100%;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    background: white;
                    margin-inline: 2rem;
                }
                .intialLoading_container{
                    width: 72px;
                    height: 72px;
                    overflow: hidden;
                    position: relative;
                }
                .intialLoading_container svg{
                    width: 64px;
                    height: 64px;
                    fill: #01aeff;
                    position: absolute;
                    top: 0%;
                    transform: translateY(0%);
                    animation: moveUp 1s cubic-bezier(0.65, 0.05, 0.36, 1) 0s infinite alternate;
                }
                .intialLoading_container svg.error{
                    fill : #fc4949;;
                    animation: none;
                }
                @keyframes moveUp{
                    0%{
                        transform: translateY(120%);
                    }
                    100%{
                        transform: translateY(0%);
                    }
                }
                .loadingInfo{
                    width: 100%;
                    text-align: center;
                    font-size: 14px;
                    color: #131313;
                    margin-top: 1rem;
                    font-weight: 700;
                }
                .scrollTopBtn{
                    position: sticky;
                    bottom: 0rem;
                    left: calc(100% - 4.5rem);
                    border-radius: 50%;
                    padding: 0.25rem;
                    background: white;
                    box-shadow: rgb(0 0 0 / 32%) 0px 0px 10px;
                    outline: none;
                    border: none;
                    cursor: pointer;
                    display: none;
                }
                .scrollTopBtn svg{
                    width: 2.5rem;
                    height: 2.5rem;
                    fill: #0098de;
                    transform: rotate(180deg);
                }
                .content_sub{
                    min-width: calc(var(--zoomLevel) - 4rem);
                    width: calc(var(--zoomLevel) - 4rem);
                    height: max-content;
                    padding-inline: 2rem;
                    margin-inline: auto;
                    margin-bottom: -3rem;
                }
                 .pdf_content{
                    width: 100%;
                    height: max-content;
                    display: flex;
                    flex-direction: column;
                    gap: 1rem;
                    justify-content: flex-start;
                    align-items: center;
                 }
                 .canvasClass{
                    width: 100%;
                    border-radius: 4px;
                    box-shadow: rgb(0 0 0 / 35%) 0px 3px 6px, rgb(0 0 0 / 37%) 0px 3px 6px;
                 }

            </style>
            <!-- <apex:styleSheet value="{!URLFOR($Resource.summerNote_Editor, '/summernote-lite.css')}"/> -->
            <apex:styleSheet value="{!URLFOR($Resource.summerNote_Editor, '/summernote-lite-pdf.css')}"/>
            <!-- <apex:includeScript value="{!URLFOR($Resource.pdfLibs, '/html2pdf.bundle.js')}"/> -->
            <apex:includeScript value="{!URLFOR($Resource.pdfLibs, '/html2pdf.bundle-0.9.3.js')}"/>
            <apex:includeScript value="{!URLFOR($Resource.pdfLibs, '/pdfJS/web/pdf.js')}"/>
        </head>
        <body>
            <apex:outputpanel rendered="{!useMode == 'preview'}">
                <!-- Toolbar section === START === -->
                <div class="pdf_toolbar">
                    <div class="configContainet">
                        <div class="pageConfig config_cc">
                            <span class="toolbarText">Page : </span>
                            <div class="pageChangeConfig">
                                <button class="pageChangeBtn pageMinus" data-name="pageMinus" onclick="onPageChange(event)" disabled="true">
                                    <svg viewBox="0 0 24 24"><path d="M10.8284 12.0007L15.7782 16.9504L14.364 18.3646L8 12.0007L14.364 5.63672L15.7782 7.05093L10.8284 12.0007Z"></path></svg>
                                </button>
                                <input class="pageToSetInut" type="number" data-name="pageToSet" onkeyup="onPageChange(event)"/>
                                <button class="pageChangeBtn pagePlus" data-name="pagePlus" onclick="onPageChange(event)">
                                    <svg viewBox="0 0 24 24" ><path d="M13.1717 12.0007L8.22192 7.05093L9.63614 5.63672L16.0001 12.0007L9.63614 18.3646L8.22192 16.9504L13.1717 12.0007Z"></path></svg>
                                </button>
                            </div>
                            <div class="toolbarText"> of </div>
                            <input class="pageToSetInut" type="number" data-name="totalPages" disabled="true"/>
                        </div>
                        <div class="zoomConfig config_cc">
                            <button data-name="zoomIn" title="Zoom In" onclick="setZoomLevel(event)">
                                <svg class="zoomBtn zI" viewBox="0 0 24 24"><path d="M5 11V13H19V11H5Z"></path></svg>
                            </button>
                            <div class="zoomInfo pageToSetInut">100%</div>
                            <button data-name="zoomOut"  title="Zoom Out" onclick="setZoomLevel(event)">
                                <svg class="zoomBtn zO" viewBox="0 0 24 24"><path d="M11 11V5H13V11H19V13H13V19H11V13H5V11H11Z"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Toolbar section === END === -->
    
                <!-- PDF preview section === START === -->
                <div class="content" id="content">
                    <div class="intialLoading">
                        <div class="intialLoading_container">
                            <svg viewBox="0 0 1920 1920" ><g stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M1706.235 1807.059H350.941V112.94h903.53v451.765h451.764v1242.353Zm-338.823-1670.74 315.443 315.447h-315.443V136.32Zm402.182 242.487L1440.372 49.58C1408.296 17.62 1365.717 0 1320.542 0H238v1920h1581.175V498.635c0-45.176-17.618-87.755-49.58-119.83ZM576.823 1242.353h790.589v-112.94H576.823v112.94Zm0-451.765h903.53V677.647h-903.53v112.941Zm0 677.647h451.765v-112.941H576.823v112.941Zm0-451.764h677.648V903.53H576.823v112.941Zm0-451.765h451.765V451.765H576.823v112.941Z" fill-rule="evenodd"></path> </g></svg>
                        </div>
                        <div class="loadingInfo"> Initializing... </div>
                    </div>
                    <div class="content_sub">
                        <div class="pdf_content" id="pdf_content"></div>
                    </div>
                    <button class="scrollTopBtn" title="Scroll To Top" onclick="scrollToTop()">
                        <svg viewBox="0 0 24 24" ><path d="M8.01266 4.56502C8.75361 4.16876 9.5587 4 11.1411 4H12.8589C14.4413 4 15.2464 4.16876 15.9873 4.56502C16.6166 4.90155 17.0985 5.38342 17.435 6.01266C17.8312 6.75361 18 7.5587 18 9.14111V14.8589C18 16.4413 17.8312 17.2464 17.435 17.9873C17.0985 18.6166 16.6166 19.0985 15.9873 19.435C15.2464 19.8312 14.4413 20 12.8589 20H11.1411C9.5587 20 8.75361 19.8312 8.01266 19.435C7.38342 19.0985 6.90155 18.6166 6.56502 17.9873C6.16876 17.2464 6 16.4413 6 14.8589V9.14111C6 7.5587 6.16876 6.75361 6.56502 6.01266C6.90155 5.38342 7.38342 4.90155 8.01266 4.56502ZM12.8589 2H11.1411C9.12721 2 8.04724 2.27848 7.06946 2.8014C6.09168 3.32432 5.32432 4.09168 4.8014 5.06946C4.27848 6.04724 4 7.12721 4 9.14111V14.8589C4 16.8728 4.27848 17.9528 4.8014 18.9305C5.32432 19.9083 6.09168 20.6757 7.06946 21.1986C8.04724 21.7215 9.12721 22 11.1411 22H12.8589C14.8728 22 15.9528 21.7215 16.9305 21.1986C17.9083 20.6757 18.6757 19.9083 19.1986 18.9305C19.7215 17.9528 20 16.8728 20 14.8589V9.14111C20 7.12721 19.7215 6.04724 19.1986 5.06946C18.6757 4.09168 17.9083 3.32432 16.9305 2.8014C15.9528 2.27848 14.8728 2 12.8589 2ZM13 6H11V11H13V6ZM7.75781 13.758L12.0005 18.0006L16.2431 13.758L14.8289 12.3438L12.0005 15.1722L9.17203 12.3438L7.75781 13.758Z"></path></svg>
                    </button>
                </div>
                <!-- PDF preview section === END === -->
            </apex:outputpanel>
        </body>

        <script type="text/javascript">
                    const parentURL = (window.location != window.parent.location) ? document.referrer : document.location.href;
                    const intialLoading = document.querySelector('.intialLoading');
                    const loadingInfo = document.querySelector('.loadingInfo');
                    const docIcon = intialLoading?.querySelector('svg');
                    const useMode = '{!JSENCODE(useMode)}';
                    

                    function sendInfoToLWC(completedChannel, status, error, cvId, errMsg, isBulk, isLast, recordId) {
                        console.log('inside sending info to lwc');
                        console.log(useMode);
                        console.log(isBulk);
                        console.log(isLast);
                        console.log(cvId);
                        console.log(completedChannel);
                        console.log(parentURL);
                        
                        if(useMode === 'preview'){
                            loadingInfo && (loadingInfo.innerText = errMsg ?? 'Facing Issue While Generating Preview, Please Try Agian...');
                            docIcon?.classList.add('error');
                            // send message to parent LWC component
                            const message = {
                                messageFrom : 'docGenerate',
                                completedChannel:completedChannel,
                                status: status,
                                error: error,
                                cvId : cvId,
                            };
                            parent.postMessage(message, parentURL);
                        }
                        else{
                            // send message to parent LWC component if useMode === 'download'
                            const message = {
                                messageFrom : 'docGenerate',
                                completedChannel:completedChannel,
                                status: status,
                                error: error,
                                cvId : cvId,
                                isBulk: isBulk,
                                isLast: isLast,
                                recordId: recordId,
                            };
                            parent.postMessage(message, parentURL);
                        }
                    }

                try {

                    const apexError = '{!JSENCODE(apexError)}';
                    apexError && console.log('apexError : ', apexError);

                    if(apexError && apexError !== null && apexError !== ''){
                        // We faced issue in apex.. so stop process here and send message to parent compoent....
                        loadingInfo && (loadingInfo.innerText = 'Facing Issue While Generating Preview, Please Try Again...');
                        docIcon?.classList.add('error');
                        sendInfoToLWC('unknown', false, {message : apexError});
                    }
                    else{
    
                        const accessToken = '{!JSENCODE(accessToken)}';
                        const fileName = '{!JSENCODE(fileName)}';
                        const recordId = '{!JSENCODE(recordId)}';
    
                        let selectedExtension = '{!JSENCODE(selectedExtension)}';   
                        const selectedChannels = '{!JSENCODE(selectedChannels)}'; 
                        const selectedFolder = '{!JSENCODE(selectedFolder)}';
                        const isBulk = '{!JSENCODE(isBulk)}';
                        const isLast = '{!JSENCODE(isLast)}';
                        const isZip = '{!JSENCODE(isZip)}';
                        const parentId = '{!JSENCODE(parentId)}';

                        console.log(selectedChannels);

                        console.log(isBulk);
                        console.log(isLast);
                        
                        
                        const domainURL = parentURL.replace('lightning.force.com/', 'my.salesforce.com');
    
                        // --- PDF page toolbar elements ----- ------
                        let pdfPages = 1;
                        let currentPage = 1;   
                        let zoomLevel = 100;
                        
                        const content = document.querySelector('.content');
                        const content_sub = document.querySelector('.content_sub');
                        const pdf_content = document.getElementById('pdf_content');
    
                        const pageToSet = document.querySelector('[data-name="pageToSet"]');
                        const pagePlus = document.querySelector('[data-name="pagePlus"]');
                        const pageMinus = document.querySelector('[data-name="pageMinus"]');
                        // --- PDF page toolbar elements --- END ----- ------
    
                        const dummyImgSrc = 'data:image/png;base64,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'
                        // Create Dynamic Node for Content....
                        const editorNode = `<div class="@typeClass note-editor note-frame">
                                                    <div class="note-editing-area">
                                                        <div aria-multiline="true" role="textbox" class="note-editable">
                                                            <HTMLContent>
                                                        </div>
                                                    </div> 
                                                </div>
                                                `
    
    
                        const pageMargins = '{!JSENCODE(pageMargins)}';
                        const pageSize = '{!JSENCODE(pageSize)}';
                        const pageUnit = '{!JSENCODE(pageConfigUnit)}';
                        const pageOriantation = '{!JSENCODE(pageOrientation)}';
    
                        const mArray = pageMargins.split(';');
                        const pageWidth = pageFormats()[pageSize][0];
                        const pageHeight = pageFormats()[pageSize][1];
    
                        const marginTop = toPx(parseFloat(mArray[0]));
                        const marginBottom = toPx(parseFloat(mArray[1]));
                        const marginLeft = toPx(parseFloat(mArray[2]));
                        const marginRight = toPx(parseFloat(mArray[3]));
    
                        let bodyHtml = '{!JSENCODE(bodyHtml)}';
                        let headerHtml = '{!JSENCODE(headerHtml)}';
                        let footerHtml = '{!JSENCODE(footerHtml)}';

                        const showHeader = JSON.parse('{!showHeader}');
                        const showFooter = JSON.parse('{!showFooter}');
    
                        const headerMarginTop = showHeader ? toPx('{!headerMarginTop}') : 0;
                        
                        const footerMarginBottom = showFooter ? toPx('{!footerMarginBottom}') : 0;
                        const headerFooterMaxHeight = (pageFormats()[pageSize][1] * 1.3334) * 0.4;
    
                        const currentTempId = '{!JSENCODE(templateId)}';
    
                        const mappingValueString = '{!JSENCODE(mappingKeyVsMappingValues)}'
                        const mappingKeyVsMappingValues = mappingValueString ? JSON.parse(mappingValueString) : {};
    
    
                        const childRecordTableKeysString = '{!JSENCODE(childRecordTableKeys)}';
                        const childRecordTableKeys = childRecordTableKeysString ? JSON.parse(childRecordTableKeysString) : {};
    
                        const salesforceImageSRCsString = '{!JSENCODE(salesforceImages)}';
                        const salesforceImages = salesforceImageSRCsString ? JSON.parse(salesforceImageSRCsString) : {};
                        
                        const mergeTemplateKeysString = '{!JSENCODE(mergeTemplateKeys)}';
                        const mergeTemplateKeys = mergeTemplateKeysString ? JSON.parse(mergeTemplateKeysString) : {};
    
                        // ###
                        const signatureImageCvIdString =  '{!JSENCODE(signatureImageCvId)}';
                        const signatureImageCvId = signatureImageCvIdString ? JSON.parse(signatureImageCvIdString) : null;
                        const signatureKey = '{!JSENCODE(signatureKey)}';
                        const signatureSize = '{!signatureSize}';

                        // Add signature image key and cv Id into salesforceImage List to fetch base64;
                        if(signatureImageCvId && signatureImageCvId[signatureKey]){
                            salesforceImages[signatureKey] = signatureImageCvId[signatureKey];
                        }

                        const imageMaxSize = '{!imageMaxSize}';
                        
                        // extract seft tempalte merge key to avoid and handle self merging...
                        const selfMergeTempKey = Object.keys(mergeTemplateKeys)?.find(key => mergeTemplateKeys[key] === currentTempId);
                        delete  mergeTemplateKeys[selfMergeTempKey];
                        
                        let isBatchRequired = '{!isBatchRequired}';
                        // --- ---- if template data is large, add template id to get data using remoteAction --- ---- 
                        if(isBatchRequired == true || isBatchRequired == 'true'){
                            mergeTemplateKeys[currentTempId] = currentTempId;
                        }
    
                        //  --- ---- Fetch current template data and and merge template data (if required) --- ---- 
                        if(Object.keys(mergeTemplateKeys)?.length ||  Object.keys(salesforceImages)?.length){
                            loadingInfo && (loadingInfo.innerText = 'Fetching Template Data...');
                            fetchData();
                        }
                        else{
                            replaceKeysWithValue();
                        }
    
                        /**
                        * Meyhod to fetch template and contetent version data from backend using remoteAction and Rest Api...
                        */
                        function fetchData() {
                            let completedProcess = 0;
                            let totalProcess = Object.keys(mergeTemplateKeys).length;
                            totalProcess = totalProcess + Object.keys(salesforceImages).length;
                            
                            let templatesData = {};
                            for(let key in mergeTemplateKeys){
                                templatesData[key] = '';
                                fetchAllTemplateData(1, mergeTemplateKeys[key], key);
                            }

                            /**
                             *  Fetch template Data in batch using remoteAction....
                             */
                            function fetchAllTemplateData(offset, templateId, mergeKey) {
                                Visualforce.remoting.Manager.invokeAction(
                                    '{!$RemoteAction.DocGenerateController.fetchTemplateData}',
                                    // 'DocGenerateController.fetchTemplateData',
                                    offset, templateId, mergeKey,
                                    function(result, event) {
                                        // console.log('event : ', event);
                                        if(event.status){
                                            let isLastBatch = result[0];
                                            templatesData[mergeKey] += result[1];
                                            if (isLastBatch == 'false') {
                                                // console.log('fetchAllTemplateData Size : ' + new Blob([JSON.stringify(templatesData)]).size / 1000000 , ' MB');
                                                fetchAllTemplateData(offset + 25, templateId, mergeKey);
                                            } else {
    
                                                templatesData[mergeKey] = unescapeHtml(templatesData[mergeKey]);
                                            
                                                // When Source tempalte is also fetch using RemoteAction...
                                                if(templateId == currentTempId){
                                                    bodyHtml = templatesData[mergeKey];
                                                    // remove current template instance from mergeTemplateKeys Instance to avoid recursion and oerride issue...
                                                    delete  mergeTemplateKeys[mergeKey];
                                                }
                                                else{
                                                    mergeTemplateKeys[mergeKey] = templatesData[mergeKey];
                                                }
    
                                                // ==> after fetching all batch for template... 
                                                proccesFurther();
                                            }
                                        }
                                        else if(event.statusCode == 414 && event.message == "Remoting response size exceeded maximum of 15 MB."){
                                            loadingInfo && l(oadingInfo.innerText = 'Your Data is to Large to generate file');
                                            docIcon?.classList.add('error');
                                        }
                                        else{
                                            mergeTemplateKeys[mergeKey] = mergeKey;
                                            proccesFurther();
                                        }
                                    }
                                );
                            }
    
                            for(let src in salesforceImages){
                                fetchContentVersionsData(salesforceImages[src], src)
                            }
                            
                            /**
                             *   Fetch Base64 for salesforce Images(Content Version) using REST API....
                             */
                            function fetchContentVersionsData(cvId, imageSRC){
                                const queryURL = `/services/data/v56.0/sobjects/ContentVersion/${cvId}/VersionData`;
    
                                const myHeaders = new Headers();
                                myHeaders.append("Authorization", "Bearer " + accessToken);
    
                                const requestOptions = {
                                    method: "GET",
                                    headers: myHeaders,
                                    redirect: "follow"
                                };
    
                                fetch(encodeURI(domainURL + queryURL), requestOptions)
                                .then(response => {
                                    response.blob()
                                    .then(blob => {
                                        if(blob.size < imageMaxSize){
                                            const reader = new FileReader();
                                            reader.onloadend = () => {
                                                salesforceImages[imageSRC] = 'data:image/png;base64,'+ reader.result.split(',')[1];
                                                proccesFurther();
                                            }
                                            reader.onerror = () => {
                                                salesforceImages[imageSRC] = dummyImgSrc;
                                                proccesFurther();
                                            }
                                            reader.readAsDataURL(blob);
                                        }
                                        else{
                                            salesforceImages[imageSRC] = dummyImgSrc;
                                            proccesFurther();
                                        }
                                    })
                                })
                                .catch(error => {
                                    salesforceImages[imageSRC] = dummyImgSrc;
                                    proccesFurther();
                                })
                            }
    
                            function proccesFurther(){
                                completedProcess++;
                                // Check if all templates data and Image base64 are fetched
                                if (completedProcess === totalProcess) {
                                    replaceKeysWithValue();
                                }
                            }
                        }
    
                        function replaceKeysWithValue(){
    
                            // Create DOM ELement for Body, header and footer
                            let bodyElement = document.createElement('div');
                            bodyElement.innerHTML = editorNode.replace('<HTMLContent>', bodyHtml);
                            bodyElement.innerHTML = bodyElement.innerHTML.replace('@typeClass', '');

                            let headerElement = document.createElement('div');
                            if(showHeader === true && headerHtml){
                                headerElement.innerHTML = editorNode.replace('<HTMLContent>', headerHtml)
                                                                        .replace('@typeClass', 'headerEditor');
                                headerElement.style = ` max-height : headerFooterMaxHeight;
                                                        overflow: hidden;`
                            }

                            let footerElement = document.createElement('div');
                            if(showFooter === true && footerHtml){
                                footerElement.innerHTML = editorNode.replace('<HTMLContent>', footerHtml)
                                                                     .replace('@typeClass', 'footerEditor');
                            }

                            // ...remove merge Template keys from mergeTemplateKeys ...
                            // Note: this logic will not remove merge Template keys from cuurent template Data as we already remove currentTempId from mergeTemplateKeys to avoid this...
                            for(let key in mergeTemplateKeys){
                                const tempData = mergeTemplateKeys[key];
                                const pattern = /{{Temp.(.*?)}}/g;
                                let matcher;
                                while(((matcher = pattern.exec(tempData)) !== null)){
                                    mergeTemplateKeys[key] = mergeTemplateKeys[key].replaceAll(matcher[0], '')
                                }
                            }
    
                            // ...replace merge template key with merge template data....
                            for(let key in mergeTemplateKeys){
                                bodyElement.innerHTML = bodyElement.innerHTML.replaceAll(key, mergeTemplateKeys[key]);
                            }
    
                            // ...if bodyElement.innerHTML have self merging key ...then append message within merge template key...
                            if(selfMergeTempKey){
                                bodyElement.innerHTML = bodyElement.innerHTML.replaceAll(selfMergeTempKey, selfMergeTempKey + '<span style="color:red"> --- Self Merge Not Allow. --- </span>');
                            }

                            // ...replace child object records....
                            for(let key in childRecordTableKeys){
                                // const tableHtml = decodeHTMLEntities(key);
                                // const modifiedTable = decodeHTMLEntities(childRecordTableKeys[key]);

                                const tableHtml = key;
                                const modifiedTable = childRecordTableKeys[key];

                                bodyElement.innerHTML = bodyElement.innerHTML.replaceAll(tableHtml, modifiedTable);
                                headerElement.innerHTML = headerElement.innerHTML.replaceAll(tableHtml, modifiedTable);
                                footerElement.innerHTML = footerElement.innerHTML.replaceAll(tableHtml, modifiedTable);
                            }

                            // ...replace object field key and general field key with actual value...
                            for(let key in mappingKeyVsMappingValues){
                                bodyElement.innerHTML = bodyElement.innerHTML.replaceAll(key, mappingKeyVsMappingValues[key]);
                                headerElement.innerHTML = headerElement.innerHTML.replaceAll(key, mappingKeyVsMappingValues[key]);
                                footerElement.innerHTML = footerElement.innerHTML.replaceAll(key, mappingKeyVsMappingValues[key])
                            }

                            // ...replace salesforce image url with base64...
                            let bodyImages = bodyElement.querySelectorAll('img');
                            let headerImages = headerElement.querySelectorAll('img');
                            let footerImages = footerElement.querySelectorAll('img');
                            let images = [...bodyImages, ...headerImages, ...footerImages]

                            images?.forEach(ele => {
                                // Check if the image Src exists in the salesforceImages object
                                if (salesforceImages[ele.src]) {
                                    ele.src = salesforceImages[ele.src];
                                }
                            })

                            let signatureValue = '';
                            // If salesforceImages Object contains signatureKey, Meanse signature image is available...
                            if(salesforceImages[signatureKey]){
                                const signatureImageInPt = (signatureSize * pageFormats()[pageSize][0]) / 100;
                                signatureValue = `<p><img style="width : ${signatureImageInPt}pt; max-width:100%;" src="${salesforceImages[signatureKey]}" ></p>`
                            }
                            
                            // replace signature key with signature image or blank string....
                            bodyElement.innerHTML = bodyElement.innerHTML.replaceAll(signatureKey, signatureValue);
                            headerElement.innerHTML = headerElement.innerHTML.replaceAll(signatureKey, signatureValue);
                            footerElement.innerHTML = footerElement.innerHTML.replaceAll(signatureKey, signatureValue);

                            // document.body.appendChild(bodyElement);
    
                            const promises = [];
                            //  ==== Convert URL src into base64 =======
                            bodyImages.forEach(ele => {
                                if(ele.src.startsWith('http')){
                                    // promises.push(convertImgToBase64(ele.src).then(base64Img => {
                                    //     ele.src = base64Img;
                                    // }));
                                    ele.src = dummyImgSrc;
                                }
                            });   
    
                            // === Once all URL image src convet to base64 src ===  exectute further process....
                            Promise.all(promises).then(() => {
                                // All images have been converted to base64
                                generateFile(bodyElement, headerElement, footerElement);
                            })
                        }
    
    
                        // ========= ========= File Generation Methods -- START --- ============== =============

                        function generateFile(bodyElement, headerElement, footerElement){
                            if(selectedExtension === '.pdf' || useMode === 'preview'){
                                generatePDF(bodyElement, headerElement, footerElement);
                            }
                            else if(selectedExtension == '.docx'){
                                // generatePDF(bodyElement);
                                selectedExtension = '.doc';
                                generateDoc(bodyElement, headerElement, footerElement);
                            }
                        }
    
                        function generatePDF(bodyElement, headerElement, footerElement){
                            
                            const opt = {
                                // margin : [top, left, bottom, right]
                                margin: [   marginTop, 
                                            marginLeft, 
                                            marginBottom, 
                                            marginRight],
                                filename: fileName + '.pdf',
                                image: { type: 'jpeg', quality: 1 },
                                html2canvas: { scale: 3 , useCORS: true , letterRendering: true},
                                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] },
                                jsPDF: { unit: 'px', format: pageSize, orientation: pageOriantation, hotfixes: ["px_scaling"] },
                            };

                            /**
                             * ... Check if content is avaolabe for not in header/footer once mapping keys are replaced,
                             * ... If content is not availbe then do not generate pdf, otherwise it will cause issue in generation
                             */
                            const isHeaderContent = !(!headerElement?.querySelector('.note-editable')?.innerHTML?.trim());
                            const isFooterContent = !(!footerElement?.querySelector('.note-editable')?.innerHTML?.trim());

                            if(showHeader === true && isHeaderContent){
    
                                const headerImgs =  headerElement.querySelectorAll('img');
                                headerImgs.forEach(ele => {
                                    if(ele.src.startsWith('http')){
                                        ele.src = dummyImgSrc;
                                    }
                                });
                        
                                // Set header options for html2pdf ...
                                opt.header = {  element : headerElement, 
                                                margins : [headerMarginTop, marginLeft, 0, marginRight], 
                                                maxHeight : headerFooterMaxHeight,              // Max height in % of page size....
                                                };             
                            }
    
                            if(showFooter === true && isFooterContent){
    
                                const footerImgs =  footerElement.querySelectorAll('img');
                                footerImgs.forEach(ele => {
                                    if(ele.src.startsWith('http')){
                                        ele.src = dummyImgSrc;
                                    }
                                });
    
                                // Set footer options for html2pdf ...
                                opt.footer = { element : footerElement, 
                                                margins : [0, marginLeft, footerMarginBottom, marginRight], 
                                                maxHeight : headerFooterMaxHeight,       // Max height in % of page size....
                                                };            
                            }
    
                            // ....Download PDF file....
                            //     html2pdf().set(opt).from(bodyElement).outputPdf().save()
    
                            // For Preview Use
                            docIcon && (docIcon.style = 'animation : none');
                            loadingInfo && (loadingInfo.innerText = 'Rendering Preview...');

    
                            html2pdf().set(opt).from(bodyElement).outputPdf()
                            .then(function (rawPDF){
                                if(useMode === 'preview'){
                                    intialLoading.style.display = 'none';
                                    displayPDF(rawPDF);
                                }
                                else{
                                    const pdfBlob = new Blob([getArrayBuffer(rawPDF)], { type: 'application/pdf' }) 
                                    const reader = new FileReader();
                                    reader.onloadend = () => {
                                        const fileData = reader.result.split(',')[1];
                                        let downlaodUrl =  reader.result;
    
                                        handleGeneratedFiles(fileData, pdfBlob, downlaodUrl);
                                    }
                                    reader.readAsDataURL(pdfBlob);
                                }
                            })
                            .catch(function (error){
                                // console.log('error to store pdf file : ', error.stack)
                                sendInfoToLWC('unknown', false, error);
                            })
                        }
    
                        function getArrayBuffer(data){
                            let len = data.length,
                            ab = new ArrayBuffer(len),
                            u8 = new Uint8Array(ab);
    
                            while (len--) u8[len] = data.charCodeAt(len);
                            return ab;
                        };
    
                        function generateDoc(bodyElement, headerElement, footerElement){
                            bodyElement.classList.add('section');
    
                                //  _html_ will be replace with custom html
                            let meta= "Mime-Version: 1.0\nContent-Base: " + location.href + "\nContent-Type: Multipart/related; boundary=\"NEXT.ITEM-BOUNDARY\";type=\"text/html\"\n\n--NEXT.ITEM-BOUNDARY\nContent-Type: text/html; charset=\"utf-8\"\nContent-Location: " + location.href + "\n\n<!DOCTYPE html>\n<html>\n_html_</html>";
                            //  _styles_ will be replaced with custome css
                            let head= "<head>\n<meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\">\n<style>\n_styles_\n</style>\n</head>\n";
                
                            const htmlElement = document.createElement('div');
                            htmlElement.classList.add('section');
                            htmlElement.innerHTML =  bodyElement.innerHTML;

                            const isHeaderContent = !(!headerElement?.querySelector('.note-editable')?.innerHTML?.trim());
                            const isFooterContent = !(!footerElement?.querySelector('.note-editable')?.innerHTML?.trim());
    
                            if( showHeader == 'true' || isHeaderContent){
                                // let headerElement = document.createElement('div');
                                // headerElement.innerHTML = editorNode.replace('<HTMLContent>', headerHtml)
                                //                                             .replace('@typeClass', 'headerEditor');
                                
                                document.body.appendChild(headerElement);
                                headerElement.style.maxheight = headerFooterMaxHeight + 'px';
                                headerElement.style.height = headerFooterMaxHeight + 'px';
                                headerElement.style.overflow = 'hidden';
                                const mainRect = headerElement.getBoundingClientRect();
                                let allChild = headerElement.querySelectorAll('*');
                                allChild?.forEach(ele => {
                                    const childRect = ele.getBoundingClientRect();
                                    if(childRect.top > mainRect.bottom){
                                        ele.remove(ele);
                                    }
                                });
                                document.body.removeChild(headerElement);
    
                                htmlElement.innerHTML += `<div style="mso-element:header" class="header" id="h1">
                                                                ${headerElement.innerHTML}
                                                            </div>`;;
                            }
    
                            if(showFooter == 'true' || isFooterContent){
    
                                // let footerElement = document.createElement('div');
                                // footerElement.innerHTML = editorNode.replace('<HTMLContent>', footerHtml)
                                //                                             .replace('@typeClass', 'footerEditor');
    
                                document.body.appendChild(footerElement);
                                footerElement.style.maxheight = headerFooterMaxHeight + 'px';
                                footerElement.style.height = headerFooterMaxHeight + 'px';
                                footerElement.style.overflow = 'hidden';
                                const mainRect = footerElement.getBoundingClientRect();
                                let allChild = footerElement.querySelectorAll('*');
                                allChild?.forEach(ele => {
                                    const childRect = ele.getBoundingClientRect();
                                    if(childRect.top > mainRect.bottom){
                                        ele.remove(ele);
                                    }
                                });
                                document.body.removeChild(footerElement);
    
                                htmlElement.innerHTML+=`<div style="mso-element:footer; visibility: hidden;" class="footer" id="f1">
                                                            ${footerElement.innerHTML}
                                                        </div>`;
                            }
    
                            let html = htmlElement.outerHTML;
    
                            let width = ptToPx(pageWidth);
                            let height = ptToPx(pageHeight);
                            if(pageOriantation == 'landscape'){
                                width = ptToPx(pageHeight);
                                height = ptToPx(pageWidth);
                            }
                            
                            let css = (
                                    `
                                        @page {
                                            mso-page-orientation: ${pageOriantation};
                                            size: ${width}px ${height}px;    
                                            margin: ${marginTop}px ${marginRight}px ${marginBottom}px ${marginLeft}px;
                                        }
    
                                        @page Section1{
                                            mso-header-margin: ${headerMarginTop}px;
                                            mso-footer-margin: ${footerMarginBottom}px;
                                            mso-footer:f1;
                                            mso-header:h1;
                                        }
    
                                        div.section{
                                            page:Section1;
                                        }
                                        p.MsoFooter, li.MsoFooter, div.MsoFooter {
                                            mso-pagination:widow-orphan;
                                        }
    
                                        .header, .footer{
                                            max-width : 100%;
                                            overflow: hidden;
                                            max-height: ${headerFooterMaxHeight}px
                                        }
    
                                        table {border-collapse: collapse; border-spacing: 0;}
                                        
                                    `
                                );
    
                            //  Image Area %%%%
                            let options = { maxWidth: 624};
                            let images = Array();
                            let img = bodyElement.querySelectorAll("img");
                            for (let i = 0; i < img.length; i++) {
                                // Calculate dimensions of output image
                                // let w = Math.min(img[i].width, options.maxWidth);
                                // let h = img[i].height * (w / img[i].width);
                                let w = img[i].width;
                                let h = img[i].height;
                                // Create canvas for converting image to data URL
                                let canvas = document.createElement("CANVAS");
                                canvas.width = w;
                                canvas.height = h;
                                // Draw image to canvas
                                let context = canvas.getContext('2d');
                                context.drawImage(img[i], 0, 0, w, h);
                                // Get data URL encoding of image
                                let uri = canvas.toDataURL("image/png");
                                img[i].setAttribute("src", img[i].src)
                                img[i].width = w;
                                img[i].height = h;
                                // Save encoded image to array
                                images[i] = {
                                    type: uri.substring(uri.indexOf(":") + 1, uri.indexOf(";")),
                                    encoding: uri.substring(uri.indexOf(";") + 1, uri.indexOf(",")),
                                    location: img[i].src,
                                    data: uri.substring(uri.indexOf(",") + 1)
                                };
                            }
    
                            // Prepare bottom of mhtml file with image data
                            let imgMetaData = "\n";
                            for (let i = 0; i < images.length; i++) {
                                imgMetaData += "--NEXT.ITEM-BOUNDARY\n";
                                imgMetaData += "Content-Location: " + images[i].location + "\n";
                                imgMetaData += "Content-Type: " + images[i].type + "\n";
                                imgMetaData += "Content-Transfer-Encoding: " + images[i].encoding + "\n\n";
                                imgMetaData += images[i].data + "\n\n";
                                
                            }
                            imgMetaData += "--NEXT.ITEM-BOUNDARY--";
                            // end Image Area %%
    
                            let output = meta.replace("_html_", head.replace("_styles_", css) +  html) + imgMetaData;
    
                            let url = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(output);
    
                            let blob = new Blob(['\ufeff', output], {
                                type: 'application/msword'
                            });
    
                            const fileData = btoa(unescape(encodeURIComponent(output)));
    
                            handleGeneratedFiles(fileData, blob, url);
                        }
                        // ========= ========= File Generation Methods -- END --- ============== =============
    
                        // === ==== ==== File Storage Method --- START --- === === =====
    
                        function handleGeneratedFiles(fileData, blob, downalodURL){
                            try {
                                const fileSizeInByte = (fileData.length / 4) * 3;
                            
                                // ....Download doc file....
                                if(selectedChannels.includes('Download') && (isBulk != 'true' || isZip == 'false')){
                                    let downloadLink = document.createElement("a");
                                    document.body.appendChild(downloadLink);
    
                                    if (navigator.msSaveOrOpenBlob) {
                                        navigator.msSaveOrOpenBlob(blob, filename + selectedExtension);
                                    } else {
                                        downloadLink.href = downalodURL;
                                        downloadLink.download = fileName + selectedExtension;
                                        downloadLink.click();
                                    }
                                    document.body.removeChild(downloadLink);
    
                                    sendInfoToLWC('Download', true, null, null, null, isBulk, isLast, recordId);
                                }
    
                                // ... store file in Salesforce Document Object ....
                                if(fileSizeInByte < 5*1020*1020 && selectedChannels.includes('Documents')){
                                    createDocument(fileData);
                                }
                                else if(selectedChannels.includes('Documents')){
                                    sendInfoToLWC('Documents', false, {message : 'File Size Limit Exceeded!'});
                                }
    
                                // ... if file size in less then 24MB, Salesforce Notes & Attachments Object ....
                                if(fileSizeInByte < 25*1020*1020 && selectedChannels.includes('Notes & Attachments')){
                                    createAttachments(fileData);
                                }
                                else if(selectedChannels.includes('Notes & Attachments')){
                                    sendInfoToLWC('Notes & Attachments', false, {message : 'File Size Limit Exceeded!'});
                                }
    
                                // ...if file size in less then 37.5, store file in Salesforce Document Object ....
                                if(fileSizeInByte < 37.5*1020*1020 && (selectedChannels.includes('Files') ||
                                    selectedChannels.includes('Chatter') || selectedChannels.includes('Email') ||
                                    selectedChannels.includes('Google Drive') || selectedChannels.includes('AWS') ||
                                    selectedChannels.includes('One Drive') || selectedChannels.includes('Dropbox') ||
                                    (isBulk == 'true'&& isZip == 'true'))){
                                {
                                    console.log('creating content version');
                                    
                                    createContentVersion(fileData);
                                }}
                                else if(selectedChannels.includes('Files') ||
                                        selectedChannels.includes('Chatter') || selectedChannels.includes('Email') ||
                                        selectedChannels.includes('Google Drive') || selectedChannels.includes('AWS') ||
                                        selectedChannels.includes('One Drive') || selectedChannels.includes('Dropbox') || 
                                        (isBulk == 'true' && isZip == 'true')){
                                    sendInfoToLWC('External Storage', false, {message : 'File Size Limit Exceeded!'});
                                }
                                
                            } catch (error) {
                                // console.log('error in handleGeneratedFiles : ', error.stack);
                                sendInfoToLWC('unknown', false, error);
                            }
                        }
    
                        function createDocument(fileData) {
                            try {
                                if (!accessToken || accessToken == '' ) {
                                    // console.error('Error fetching session ID fro create document');
                                    sendInfoToLWC('Documents', false, {message : 'Error fetching session ID fro create document'});
                                }
                            
                                const myHeaders = new Headers();
                                myHeaders.append("Authorization", "Bearer " + accessToken);
                                myHeaders.append("Content-Type", "application/json");
                            
                                const raw = JSON.stringify({
                                    "Name": fileName,
                                    "Type": selectedExtension.split(".")[1],
                                    "FolderId": selectedFolder,
                                    "Body": fileData
                                });
                            
                                const requestOptions = {
                                    method: 'POST',
                                    headers: myHeaders,
                                    body: raw,
                                    redirect: 'follow'
                                };
                            
                                const queryURL = "/services/data/v61.0/sobjects/Document";
                            
                                // const response = await fetch(encodeURI(domainURL + queryURL), requestOptions);
                                fetch(encodeURI(domainURL + queryURL), requestOptions)
                                .then(response => {
                                    response.json()
                                    .then(result => {
                                        if (result.success) {
                                            sendInfoToLWC('Documents', true, null, null, null, isBulk, isLast, recordId);
                                        }
                                        else{
                                            sendInfoToLWC('Documents', false, result.error);
                                        }
                                    })
                                })
                                .catch(error => {
                                    // console.error('Error creating sf document:', error);
                                })
                                // console.log('result of create sf document ', result);
                            
                            } catch (error) {
                                // console.error('Error creating sf document:', error.stack);
                                sendInfoToLWC('Documents', false, error);
                            } 
                        }
    
                        function createAttachments(fileData) {
                            try {
    
                                if (!accessToken || accessToken == '' ) {
                                    // console.error('Error fetching session ID fro create attachment');
                                    sendInfoToLWC('Notes & Attachments', false, {message : 'Error fetching session ID fro create attachment'});
                                }
    
                                let contentType = '';
                                if(selectedExtension == '.pdf'){
                                    contentType = 'application/pdf';
                                }else if(selectedExtension == '.docx'){
                                    contentType = 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';
                                }
    
                                const myHeaders = new Headers();
                                myHeaders.append("Authorization", "Bearer " + accessToken);
                                myHeaders.append("Content-Type", "application/json");
                                
                                if (parentId && parentId != '') {
                                    const raw = JSON.stringify({
                                    "Name": fileName + selectedExtension,
                                    "ParentId": parentId,
                                    "contentType": contentType,
                                    "Body": fileData
                                    });
                                }
                                else{
                                    const raw = JSON.stringify({
                                        "Name": fileName + selectedExtension,
                                        "ParentId": recordId,
                                        "contentType": contentType,
                                        "Body": fileData
                                    });
                                }
                            
                                const requestOptions = {
                                    method: 'POST',
                                    headers: myHeaders,
                                    body: raw,
                                    redirect: 'follow'
                                };
                            
                                const queryURL = "/services/data/v61.0/sobjects/Attachment";
                                // const response = await fetch(encodeURI(domainURL + queryURL), requestOptions);
                                fetch(encodeURI(domainURL + queryURL), requestOptions)
                                .then(response => {
                                    response.json()
                                    .then(result => {
                                        if (result.success) {
                                            sendInfoToLWC('Notes & Attachments', true, null, null, null, isBulk, isLast, recordId);
                                        }
                                        else{
                                            sendInfoToLWC('Notes & Attachments', false, result.error);
                                        }
                                    })
                                })
                                .catch(error => {
                                    // console.error('Error creating Notes & Attachments:', error);
                                })
                            
                                // console.log(' create attachment result : ', result);
                            
                            } catch (error) {
                                // console.error('error in create Attachment : ', error.stack);
                                sendInfoToLWC('Notes & Attachments', false, error);
                            }
                        }
    
                        function createContentVersion(fileData){
                            try {
    
                                if (!accessToken || accessToken == '' ) {
                                    // console.error('Error fetching session ID fro create conetentVersion');
                                    sendInfoToLWC('Files', false, {message : 'Error fetching session ID fro create conetentVersion'});
                                }
    
                                const myHeaders = new Headers();
                                myHeaders.append("Authorization", "Bearer " + accessToken);
                                myHeaders.append("Content-Type", "application/json");
                            
                                const raw = JSON.stringify({
                                    "title": fileName,
                                    "PathOnClient": fileName + selectedExtension,
                                    "versionData": fileData
                                });
                            
                                const requestOptions = {
                                    method: "POST",
                                    headers: myHeaders,
                                    body: raw,
                                    redirect: "follow"
                                };
                            
                                const queryURL = "/services/data/v61.0/sobjects/ContentVersion";
    
                                fetch(encodeURI(domainURL + queryURL), requestOptions)
                                .then(response => {
                                    response.json()
                                    .then(result => {
                                        if (!result.success || !result.id) {
                                            // console.log('Couldn\'t create the content version');
                                            sendInfoToLWC('External Storage', false, result.error);
        
                                        }
                                        else{
                                            sendInfoToLWC('External Storage', true, null, result.id, null, isBulk, isLast, recordId);
                                        }
                                    })
                                })
                                .catch(error => {
                                    // console.log('error in External Storage : ', error.json());
                                    sendInfoToLWC('External Storage', true, null, result.id);
                                })
                                // console.log('result of create contetVersion : ', result);
                            
    
    
                            } catch (error) {
                                // console.log('Error in createContentVersion ::', error.message);
                                sendInfoToLWC('Files', false, error);
                            }
                        }
                        // === ==== ==== File Storage Method --- END --- === === =====

                        // === ==== ==== File Storage Method --- END --- === === =====
    
                        // ===== ==== GENERIC METHODS -- START -- ==== =====
    
                        // ==== ===  Function to convet URL src to base64 src using canvas APIs ==== =====

                        function convertImgToBase64(url) {
                            return new Promise((resolve, reject) => {
                                let img = new Image();
                                img.crossOrigin = '*';
                                img.src = url;
                                img.onload = function() {
                                    let canvas = document.createElement('canvas');
                                    canvas.width = img.width;
                                    canvas.height = img.height;
                                    let ctx = canvas.getContext('2d');
                                    ctx.drawImage(img, 0, 0);
                                    let dataURL = canvas.toDataURL('image/png');
                                    resolve(dataURL);
                                };
                                img.onerror = function() {
                                    // replace CORS Block Images with dummy IMAGE...
                                    resolve('data:image/png;base64,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');
                                };
                            })
                        }
    
                        function getArrayBuffer(data){
                            let len = data.length,
                            ab = new ArrayBuffer(len),
                            u8 = new Uint8Array(ab);
    
                            while (len--) u8[len] = data.charCodeAt(len);
                            return ab;
                        };
    
                        // ==> unescape the htmlTag using DOM parder...

                        function unescapeHtml(html){
                            let doc = new DOMParser().parseFromString(html, "text/html");
                            return doc.documentElement.innerText
                        }
    
                        // ==> decode the htmlTag entities...

                        function decodeHTMLEntities(text){
                            const textArea = document.createElement('textarea');
                            textArea.innerHTML = text;
                            return textArea.value;
                        }
    
                        // ===== ==== GENERIC METHODS -- START -- ==== =====
    
                        // ==== Page Size in (pt) unit...

                        function pageFormats(){
                            return {
                                'a0': [2383.94, 3370.39],
                                'a1': [1683.78, 2383.94],
                                'a2': [1190.55, 1683.78],
                                'a3': [841.89, 1190.55],
                                'a4': [595.28, 841.89],
                                'a5': [419.53, 595.28],
                                'a6': [297.64, 419.53],
                                'a7': [209.76, 297.64],
                                'a8': [147.40, 209.76],
                                'a9': [104.88, 147.40],
                                'a10': [73.70, 104.88],
                                'b0': [2834.65, 4008.19],
                                'b1': [2004.09, 2834.65],
                                'b2': [1417.32, 2004.09],
                                'b3': [1000.63, 1417.32],
                                'b4': [708.66, 1000.63],
                                'b5': [498.90, 708.66],
                                'b6': [354.33, 498.90],
                                'b7': [249.45, 354.33],
                                'b8': [175.75, 249.45],
                                'b9': [124.72, 175.75],
                                'b10': [87.87, 124.72],
                                'c0': [2599.37, 3676.54],
                                'c1': [1836.85, 2599.37],
                                'c2': [1298.27, 1836.85],
                                'c3': [918.43, 1298.27],
                                'c4': [649.13, 918.43],
                                'c5': [459.21, 649.13],
                                'c6': [323.15, 459.21],
                                'c7': [229.61, 323.15],
                                'c8': [161.57, 229.61],
                                'c9': [113.39, 161.57],
                                'c10': [79.37, 113.39],
                                'dl': [311.81, 623.62],
                                'letter': [612, 792],
                                'government-letter': [576, 756],
                                'legal': [612, 1008],
                                'junior-legal': [576, 360],
                                'ledger': [1224, 792],
                                'tabloid': [792, 1224],
                                'credit-card': [153, 243],
                                'executive' : [522, 756],       // DocGenius Changes....
                                'statement' : [396, 594],       // DocGenius Changes....
                            }
                        }; 
    
    
                        // --- ---- --- for pt Unit ---- ----- ----

                        function unitMultiplier(unit){
                            switch (unit) {
                                case 'pt':
                                return 1;
                            
                                case 'mm':
                                return 72 / 25.4;
                            
                                case 'cm':
                                return 72 / 2.54;
                            
                                case 'in':
                                return 72;
                            
                                case 'px':
                                return 72 / 96;
                            
                                case 'pc':
                                return 12;
                            
                                case 'em':
                                return 12;
                            
                                case 'ex':
                                return 6;
                            
                                default:
                                return null;
                            }
                        };
    
                        function toPx(value){
                            let toPt = unitMultiplier(pageUnit) * value;
                            return (toPt * 1.3334);
                        }
    
                        function ptToCm(value){
                            return (value / 28.3465);
                        }
    
                        function ptToPx(value){
                            return (value * 1.3334);
                        }
    
                        // ===== ====== ====== Preview Functionality -- START -- ====== ====== =======
                            //  --- ---- Convert pdf page into canvas append in body --- ---- 
                            function displayPDF(pdfBlob) {
                                let loadingTask = pdfjsDistBuildPdf?.getDocument({ data: pdfBlob });
                                loadingTask.promise.then(function (pdf) {
                                    pdfPages = pdf.pdfInfo.numPages;

                                    if(pdfPages >= 20){
                                        intialLoading && (intialLoading.style.display = 'flex');
                                        const errMsg = 'Your Data is to Large to generate file !';
                                        loadingInfo && (loadingInfo.innerHTML = errMsg);
                                        docIcon && docIcon.classList.add('error');
                                        sendInfoToLWC('Generate Preview Error', false, {message : 'Page Size Limit Exceeded!'}, null, errMsg);
                                        return;
                                    }
    
                                    const totalPagesInput = document.querySelector('[data-name="totalPages"]');
                                    totalPagesInput && (totalPagesInput.value = pdf.pdfInfo.numPages);
    
                                    const pageToSetInut = document.querySelector('[data-name="pageToSet"]');
                                    pageToSetInut && (pageToSetInut.value = currentPage);
    
    
                                    for (let i = 1; i <= pdf.pdfInfo.numPages; i++) {
                                        let pageNum = i;
                                        pdf.getPage(i).then(function (page) {
    
                                            // PDFViewerApplicationOptions.set('printResolution', 300);
                                            let scale = 1.5;
                                            // Support HiDPI-screens.
                                            let outputScale = window.devicePixelRatio || 1.1;
                                            outputScale = outputScale != 1 ? outputScale : 1.1;
    
                                            let viewport = page.getViewport(scale);
    
                                            let canvas = document.createElement('canvas');
                                            pdf_content.appendChild(canvas);
                                            let context = canvas.getContext('2d');
    
                                            let Print_unit = 4.19;
    
                                            canvas.width = Math.floor(viewport.width * Print_unit);
                                            canvas.height = Math.floor(viewport.height * Print_unit);
                                            canvas.classList.add('canvasClass');
                                            canvas.style = `aspect-ratio : ${viewport.width / viewport.height}`;
    
                                            let transform = outputScale !== 1
                                                ? [Print_unit, 0, 0, Print_unit, 0, 0]
                                                : null;
    
                                            // Render PDF page into canvas context
                                            let renderContext = {
                                                canvasContext: context,
                                                transform: transform,
                                                viewport: viewport,
                                                intent: 'print'
                                            };
    
                                            let renderTask = page.render(renderContext);
    
                                        }, 
                                        // function (reason) {
                                        //     // PDF loading error
                                        //     console.error(reason);
                                        // }
                                    );
                                    }
                                });
                            }

                            // ************** ToolBar Methods -- START -- ***************
                            function setZoomLevel(event){
                                const clickedButton = event.currentTarget.dataset.name
                                let zoomOffset = 10;
    
                                if(zoomLevel <= 25){
                                    zoomOffset = clickedButton == 'zoomIn' ? 0 : zoomOffset;
                                }
                                else if(zoomLevel >= 500){ 
                                    zoomOffset = clickedButton == 'zoomOut' ? 0 : zoomOffset;
                                }

                                if( clickedButton == "zoomIn"){
                                    zoomLevel = zoomLevel - zoomOffset;
                                }
                                else if(clickedButton == "zoomOut"){
                                    zoomLevel = zoomLevel + zoomOffset;
                                }
            
                                content_sub.style = `--zoomLevel : ${zoomLevel}% !important;`;
    
                                const zoomInfo = document.querySelector('.zoomInfo');
                                zoomInfo.innerText = zoomLevel + '%';
                            }
    
                            content?.addEventListener("scroll", (event) => {
                                onscroll();
                            });
    
                            function onscroll(){
                                let scrollHeight = content.scrollHeight;
                                const addon = currentPage === 1 ? 16 : 4;
                                const singlePageHeight = (content.scrollHeight / pdfPages) - addon;
    
                                currentPage =  Math.floor((content.scrollTop / (singlePageHeight)) + 1);
    
                                const pageToSetInut = document.querySelector('[data-name="pageToSet"]');
                                pageToSetInut.value = currentPage;
    
                                const scrollToTopBtn = document.querySelector('.scrollTopBtn');
                                if(content.scrollTop > 0){
                                    scrollToTopBtn.style = 'display : block !important';
                                }
                                else{
                                    scrollToTopBtn.style = '';
                                }
    
                                setPageBtnStatus();
                            }
    
                            function onPageChange(event){
                                const dataName = event.currentTarget.dataset.name;
    
                                let pageNoToSet = currentPage;
                                if(dataName == "pageToSet"){
                                    pageNoToSet = event.target.value;
                                }
                                else if(dataName == "pagePlus"){
                                    pageNoToSet = currentPage + 1;
                                }
                                else if(dataName == "pageMinus"){
                                    pageNoToSet = currentPage - 1;
                                }
    
                                if((pageNoToSet > pdfPages || pageNoToSet <= 0) && pageNoToSet != ''){
                                    pageToSet.value = currentPage;
                                }
                                else{
                                    if(pageNoToSet != currentPage && pageNoToSet != ''){
                                        const singlePageHeight = content.scrollHeight / pdfPages;
                                        content.scrollTop = (singlePageHeight) * (pageNoToSet - 1);
                                        currentPage = pageNoToSet;
                                    }
                                    pageToSet.value = currentPage;
                                }

                                // const pageToSetInut = document.querySelector('[data-name="pageToSet"]');
    
                                setPageBtnStatus();

                            }
    
                            function setPageBtnStatus(){
                                if(currentPage <= 1){
                                    pageMinus.setAttribute('disabled', 'true');
                                }
                                else{
                                    pageMinus.removeAttribute('disabled');
                                }
    
                                if(currentPage >= pdfPages){
                                    pagePlus.setAttribute('disabled', 'true');
                                }
                                else{
                                    pagePlus.removeAttribute('disabled');
                                }
                            }
    
                            function scrollToTop(){
                                content.scrollTop = 0;
                                onscroll();
                            }
                            // ======= ========= ToolBar Methods -- END -- ========= ==========
                        // ===== ====== ====== Preview Functionality -- START -- ====== ====== =======
                    }
                } 
                catch (error) {
                    // console.error('error in docGenerate JS : ', error.stack);
                    sendInfoToLWC('unknown', false, error);
                }

        </script>

        
    </html>
</apex:page>